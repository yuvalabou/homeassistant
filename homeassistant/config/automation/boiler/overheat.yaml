---

- alias: "Safety: Boiler Overheat Protocol"
  id: 9614dc27-4752-4468-a096-409ed6ea1bfc
  trigger:
    - id: 'overheating'
      trigger: state
      entity_id: binary_sensor.boiler_overheating
      to: 'on'
    - id: 'manual_reset'
      trigger: state
      entity_id: switch.boiler
      to: 'on'
  action:
    - choose:
        - conditions:
            - condition: trigger
              id: 'overheating'
          sequence:
            - action: switch.turn_off
              target:
                entity_id: switch.boiler
            - action: input_boolean.turn_on
              target:
                entity_id: input_boolean.boiler_overheated
            - action: notify.mobile_app_yuval
              data:
                title: "ðŸ”¥ BOILER EMERGENCY STOP"
                message: "Boiler killed at {{ states('sensor.boiler_device_temperature') }}Â°C. System locked."
                data:
                  push:
                    sound:
                      name: "critical_alert"
                      volume: 1.0

        - conditions:
            - condition: trigger
              id: 'manual_reset'
          sequence:
            - choose:
                - conditions:
                    - condition: state
                      entity_id: binary_sensor.boiler_overheating
                      state: 'off'
                  sequence:
                    - action: input_boolean.turn_off
                      target:
                        entity_id: input_boolean.boiler_overheated
              default:
                - action: switch.turn_off
                  target:
                    entity_id: switch.boiler
                - action: notify.mobile_app_yuval
                  data:
                    message: "Cannot start boiler: Overheat sensor is still active."

- alias: "Boiler: Auto-Reset Error Flag"
  id: 508d9883-137c-45f4-96ae-231d7c205ff4
  trigger:
    - trigger: numeric_state
      entity_id: sensor.boiler_device_temperature
      below: 50 # Safe re-start temperature
  condition:
    - condition: state
      entity_id: input_boolean.boiler_overheated
      state: 'on'
  action:
    - action: input_boolean.turn_off
      target:
        entity_id: input_boolean.boiler_overheated
    - action: notify.mobile_app_yuval
      data:
        message: "Boiler has cooled to {{ states('sensor.boiler_device_temperature') }}Â°C. Safety lock removed."
