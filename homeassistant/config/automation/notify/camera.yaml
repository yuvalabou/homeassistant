---

- alias: 'Reolink Motion Push Notification'
  id: '98d1c7bd-5abf-4f4c-ab0a-c72cce8456fe'
  description: 'Sends a snapshot when a person or animal is detected in the garden while no one is home.'
  mode: queued
  max: 3
  trigger:
    - trigger: state
      entity_id: binary_sensor.rlc_510wa_aboulafia_person
      to: 'on'
      id: 'person'
    - trigger: state
      entity_id: binary_sensor.rlc_510wa_aboulafia_animal
      to: 'on'
      id: 'animal'
  condition:
    - condition: state
      entity_id: group.person
      state: 'not_home'
    - condition: template
      value_template: >-
        {{ as_timestamp(now()) - as_timestamp(state_attr(this.entity_id, 'last_triggered'), 0) > 30 }}
  action:
    # Define all dynamic variables upfront based on the trigger.
    # This keeps the logic clean and avoids repeating code (DRY principle).
    - variables:
        object_type: "{{ trigger.id | capitalize }}"
        timestamp: "{{ now().strftime('%Y%m%d_%H%M%S') }}"
        snapshot_filename: "reolink/{{ trigger.id }}_{{ timestamp }}.jpg"
    - action: camera.snapshot
      target:
        entity_id: camera.rlc_510wa_aboulafia_fluent
      data:
        filename: "/config/www/{{ snapshot_filename }}"
    - delay:
        seconds: 1
    - action: notify.mobile_app_yuval
      data:
        title: "{{ object_type }} Detected in Garden"
        message: "A {{ trigger.id }} was detected by the garden camera at {{ now().strftime('%H:%M') }}."
        data:
          image: "/local/{{ snapshot_filename }}"
          tag: "garden-camera-alert"
          channel: "alerts"
          priority: "high"
